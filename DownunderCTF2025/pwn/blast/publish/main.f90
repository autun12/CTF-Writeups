SUBROUTINE MENU
  IMPLICIT NONE

  PRINT *, "MENU:"
  PRINT *, "1: PRINT TRANSFORM"
  PRINT *, "2: FORWARD PASS"
  PRINT *, "3: BACKWARD PASS"
  PRINT *, "4: EXIT"
  PRINT *, "> "
END SUBROUTINE MENU

SUBROUTINE LOAD_FLAG
  IMPLICIT NONE
  CHARACTER(LEN=128), SAVE :: FLAG
  INTEGER :: UNIT, IOS
  CHARACTER(LEN=*), PARAMETER :: FILENAME = "FLAG.TXT"

  OPEN(NEWUNIT=UNIT, FILE=FILENAME, STATUS='OLD', ACTION='READ')
  READ(UNIT, *) FLAG

  CLOSE(UNIT)
END SUBROUTINE LOAD_FLAG

SUBROUTINE PRINT_MATRIX(A, M, N)
  USE ISO_FORTRAN_ENV, ONLY: UINT8
  IMPLICIT NONE
  INTEGER, INTENT(IN) :: M, N
  UNSIGNED(KIND=UINT8) :: A(M, N)
  INTEGER :: I, J

  DO J = 0, N - 1
     DO I = 0, M - 1
        PRINT *, A(I, J)
     END DO
  END DO
END SUBROUTINE PRINT_MATRIX

SUBROUTINE PRINT_ERROR
  PRINT *, "INVALID INPUT"
END SUBROUTINE PRINT_ERROR

SUBROUTINE READ_MATRIX(A, M, N)
  USE ISO_FORTRAN_ENV, ONLY: UINT8
  IMPLICIT NONE
  INTEGER, INTENT(IN) :: M, N
  UNSIGNED(KIND=UINT8), INTENT(OUT) :: A(M, N)
  INTEGER :: I, J
  DO J = 0, N - 1
     DO I = 0, M - 1
        READ(*, *) A(I, J)
     END DO
  END DO
END SUBROUTINE READ_MATRIX

SUBROUTINE INIT_MATRIX(A, M, N)
  USE ISO_FORTRAN_ENV, ONLY: UINT8
  IMPLICIT NONE
  INTEGER, INTENT(IN) :: M, N
  UNSIGNED(KIND=UINT8), INTENT(OUT) :: A(M, N)

  CALL RANDOM_INIT(.TRUE., .FALSE.)
  CALL RANDOM_NUMBER(A)
END SUBROUTINE

SUBROUTINE GET_USER_CHOICE(CHOICE)
  IMPLICIT NONE
  INTEGER, INTENT(OUT) :: CHOICE
  CALL MENU()
  READ *, CHOICE
END SUBROUTINE

SUBROUTINE MATVECMUL(A, B, C, M, N, P)
  USE ISO_FORTRAN_ENV, ONLY: UINT8
  IMPLICIT NONE
  INTEGER, INTENT(IN) :: M, N, P
  UNSIGNED(KIND=UINT8), INTENT(IN) :: A(M, N)
  UNSIGNED(KIND=UINT8), INTENT(IN) :: B(N, P)
  UNSIGNED(KIND=UINT8), INTENT(OUT) :: C(M, P)
  INTEGER :: I, J, K

  DO I = 0, M - 1
     DO J = 0, P - 1
        C(I, J) = 0U_UINT8
     END DO
  END DO

  DO I = 0, M - 1
     DO J = 0, P - 1
        DO K = 0, N - 1
           C(I, J) = C(I, J) + A(I, K) * B(K, J)
        END DO
    END DO
  END DO
END SUBROUTINE MATVECMUL

PROGRAM BLAST
  USE ISO_FORTRAN_ENV, ONLY : UINT8
  IMPLICIT NONE
  INTEGER, PARAMETER :: M = 16
  INTEGER, PARAMETER :: N = 1
  INTEGER, SAVE :: CHOICE = 0
  UNSIGNED(KIND=UINT8) :: A(M, N), B(M, M), C(M, N)

  CALL LOAD_FLAG

  CALL INIT_MATRIX(A, M, N)
  CALL INIT_MATRIX(B, M, M)
  CALL INIT_MATRIX(C, M, N)

  DO
    CALL GET_USER_CHOICE(CHOICE)
    IF (CHOICE == 1) THEN
       ! PRINT TRANSFORM
       CALL PRINT_MATRIX(B, M, M)
    ELSE IF (CHOICE == 2) THEN
       ! FORWARD PASS
       CALL READ_MATRIX(A, M, N)
       CALL MATVECMUL(B, A, C, M, M, N)
    ELSE IF (CHOICE == 3) THEN
       ! BACKWARD PASS
       CALL MATVECMUL(B, C, A, M, M, N)
       CALL PRINT_MATRIX(A, M, N)
    ELSE IF (CHOICE == 4) THEN
       ! EXIT
       EXIT
    ELSE
       ! INVALID
       CALL PRINT_ERROR()
    END IF
  END DO
END PROGRAM BLAST
